<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>04 Webassembly in-depth</title>

    <link rel="icon" href="../img/zuehlke_logo.jpg">
    <link rel="stylesheet" href="../css/reveal.css">
    <link rel="stylesheet" href="../css/theme/zuehlke.css">

    <!-- Theme used for syntax highlighting of code -->
    <link rel="stylesheet" href="../lib/css/atom-one-dark.css">

    <!-- Printing and PDF exports -->
    <script>
      var link = document.createElement('link');
      link.rel = 'stylesheet';
      link.type = 'text/css';
      link.href = window.location.search.match(/print-pdf/gi) ? '../css/print/pdf.css' : '../css/print/paper.css';
      document.getElementsByTagName('head')[0].appendChild(link);
    </script>
</head>
<body>
<div class="reveal">
    <div class="slides">
        <section class="deck-slide">
            <h1>04 Webassembly in-depth</h1>
        </section>
        <section>
            <section>
                <h2>Instantiation</h2>
            </section>
            <section>
                <h2>Webassembly.instantiate</h2>
                <pre>
                <code class="hljs js" data-trim contenteditable data-noescape>
                    fetch('../out/main.wasm')
                        .then(response => response.arrayBuffer())
                        .then(bytes => WebAssembly.instantiate(bytes))
                </code>
                </pre>
            </section>
            <section>
                <h2>Webassembly.instantiateStreaming</h2>
                <pre>
                <code class="hljs js" data-trim contenteditable data-noescape>
                    WebAssembly
                        .instantiateStreaming(fetch('../out/main.wasm'))
                        .then(instance => /* do something */);
                </code>
                </pre>
            </section>
            <section>
                <h2>Webassembly.instantiateStreaming</h2>
                <ul>
                    <li>Better performance than instantiate</li>
                    <li>No conversion to ArrayBuffer</li>
                    <li>Fetch, compile and instantiate in one step</li>
                    <li class="fragment">Not yet supported in Safari</li>
                </ul>
            </section>
            <section>
                <h2>Methods we won't use</h2>
                <ul>
                    <li>compile</li>
                    <li>compileStreaming</li>
                    <li>validate</li>
                </ul>
            </section>
        </section>
        <section>
            <section>
                <h2>Handling complex types</h2>
            </section>
            <section>
                <h2>Let's return a String</h2>
                <ul>
                    <li>wasm only knows some numeric types</li>
                    <li>Create String and return pointer</li>
                    <li>Read String from heap in JS</li>
                </ul>
            </section>
            <section>
                <h2>Rust</h2>
                <pre>
                <code class="hljs rust" data-trim contenteditable data-noescape>
                    use std::ffi::CString;
                    use std::os::raw::c_char;

                    #[no_mangle]
                    pub extern "C" fn getWelcomeMessage() -> *mut c_char {
                        let s = format!("Hello {}!", "from Rust");
                        let s = CString::new(s).unwrap();
                        s.into_raw()
                    }
                </code>
                </pre>
            </section>
            <section>
                <h2>CString</h2>
                <ul>
                    <li>C-Compatible String</li>
                    <li>nul-terminated</li>
                    <li>No nul bytes in the middle</li>
                </ul>
            </section>
            <section>
                <h2>c_char</h2>
                <ul>
                    <li>Representation of C base type</li>
                </ul>
            </section>
            <section>
                <h2>into_raw</h2>
                <ul>
                    <li>Convert to pointer</li>
                    <li>Hand off memory management</li>
                    <li>No GC of this memory by Rust</li>
                </ul>
            </section>
            <section>
                <h2>Memory leak?</h2>
                <ul>
                    <li>String is on wasm heap</li>
                    <li>JS will not do GC for this</li>
                </ul>
            </section>
            <section>
                <h2>Rust</h2>
                <pre>
                <code class="hljs rust" data-trim contenteditable data-noescape>
                    #[no_mangle]
                    pub extern "C" fn dealloc_str(ptr: *mut c_char) {
                        unsafe {
                            let _ = CString::from_raw(ptr);
                        }
                    }
                </code>
                </pre>
            </section>
            <section>
                <h2>unsafe</h2>
                <ul>
                    <li>Usually we only write safe Rust code</li>
                    <li>Here we read from a arbitrary pointer</li>
                    <li>No type-safety</li>
                    <li>No memory-safety</li>
                </ul>
            </section>
            <section>
                <h2>JavaScript</h2>
                <pre>
                <code class="hljs js" data-trim contenteditable data-noescape>
                    const module = result.instance.exports;
                    let pointer = module.getWelcomeMessage();
                    let message = copyCStr(module, pointer);
                    document.getElementById("container").textContent = message;
                </code>
                </pre>
            </section>
            <section>
                <pre>
                <code class="hljs js" data-trim contenteditable data-noescape>
                    function copyCStr(module, ptr) {
                        let orig_ptr = ptr;
                        function* collectCString() {
                            let memory = new Uint8Array(module.memory.buffer);
                            while (memory[ptr] !== 0) {
                                if (memory[ptr] === undefined) { throw new Error("Tried to read undef mem") }
                                yield memory[ptr]
                                ptr += 1
                            }
                        }

                        const buffer_as_u8 = new Uint8Array(collectCString())
                        const utf8Decoder = new TextDecoder("UTF-8");
                        const buffer_as_utf8 = utf8Decoder.decode(buffer_as_u8);
                        module.dealloc_str(orig_ptr);
                        return buffer_as_utf8
                    }
                </code>
                </pre>
            </section>
            <section>
                <h2>copyCStr</h2>
                <ul>
                    <li>Get Array from wasm memory buffer</li>
                    <li>Read until we get to the first 0</li>
                    <li>Decode given bytes as UTF-8</li>
                    <li>Call dealloc function from Rust</li>
                </ul>
            </section>
            <section>
                <h2>Exercise Time!</h2>
                <ul>
                    <li>Return a string from Rust</li>
                </ul>
            </section>
        </section>
        <section>
            <h2>Resources</h2>
            <ul>
                <li>
                    <a href="https://github.com/rustwasm/wasm-pack" target="_blank">
                        wasm-pack ðŸ“¦
                    </a>
                </li>
            </ul>
        </section>
        <section class="deck-slide">
            <h1>Questions?</h1>
        </section>
    </div>
</div>

<script src="../lib/js/head.min.js"></script>
<script src="../js/reveal.js"></script>

<script>
  // More info https://github.com/hakimel/reveal.js#configuration
  Reveal.initialize({
    history: true,

    // More info https://github.com/hakimel/reveal.js#dependencies
    dependencies: [
      { src: '../plugin/markdown/marked.js' },
      { src: '../plugin/markdown/markdown.js' },
      { src: '../plugin/notes/notes.js', async: true },
      {
        src: '../plugin/highlight/highlight.js', async: true, callback: function () {
          hljs.initHighlightingOnLoad();
        }
      }
    ]
  });
</script>
</body>
</html>
